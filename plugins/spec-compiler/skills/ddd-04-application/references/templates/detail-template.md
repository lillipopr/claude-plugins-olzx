# 第四章：应用层设计

## 章节目标

完成应用层设计，包括：
1. **应用服务列表**：列出所有应用服务
2. **用户行为列表**：列出用户操作
3. **系统行为列表**：列出系统操作
4. **事件处理**：设计事件监听器，处理聚合根发布的领域事件
5. **服务详细设计**：设计每个应用服务的方法、职责、约束
6. **服务用例设计**：设计每个应用服务的方法设计测试用例

---

### 1. 应用服务列表

| 服务名称 | 职责 | 对应聚合 | 对应领域服务 |
|---------|------|---------|-------------|
| {服务1} | {职责描述} | {聚合A} | {领域服务X} |
| {服务2} | {职责描述} | {聚合B} | - |

---

### 2. 用户行为列表

| 行为名称 | 应用服务 | 聚合根方法 | 权限要求 |
|---------|---------|-----------|---------|
| {行为1} | {服务A} | {方法X} | {权限要求} |
| {行为2} | {服务B} | {方法Y} | {权限要求} |

---

### 3. 系统行为列表

| 行为名称 | 触发条件 | 应用服务 | 聚合根方法 |
|---------|---------|---------|-----------|
| {行为1} | {触发条件} | {服务A} | {方法X} |
| {行为2} | {触发条件} | {服务B} | {方法Y} |

---

### 4. 事件监听器列表

| 监听器名称 | 监听的事件 | 处理逻辑 | 影响的聚合 | 所属应用服务 |
|-----------|-----------|---------|-----------|-------------|
| {监听器1} | {事件1} | {逻辑描述} | {聚合A} | {当前服务} |
| {监听器2} | {事件2} | {逻辑描述} | {聚合B} | {当前服务} |

---

### 4.1 监听器：{监听器名称}

**监听事件**：{事件名称}

**职责**：{简要描述监听器的核心职责}

**处理逻辑**：{详细描述处理步骤}

**处理步骤**：
1. **事件接收**：从事件总线接收 {事件名称}
2. **幂等性检查**：
    - 幂等键：`event:{事件名称}:{event.eventId}`
    - 已处理则直接返回
3. **参数校验**：
    - 校验 {字段1} 不为空
    - 校验 {字段2} 符合格式
4. **调用领域服务/聚合**：
    - 调用 {服务/聚合}.{方法}({参数})
5. **结果处理**：
    - 成功：标记已处理，记录日志
    - 失败：记录错误日志，根据配置决定是否重试

**异常处理**：

| 异常类型 | 处理方式 | 是否重试 |
|---------|---------|---------|
| {异常1} | {处理方式} | 是 |
| {异常2} | 发送到死信队列，告警 | 否 |

**幂等性保证**：

| 幂等键 | 存储位置 | 说明 |
|-------|---------|------|
| eventId | Redis/DB | 通过 eventId 去重，避免重复消费 |

---

### 5. 单个应用服务详细设计

#### 5.1 应用服务：{服务名称}

**基本信息**

| 字段 | 值 |
|------|-----|
| 服务名称 | {服务名称} |
| 职责 | {职责描述} |
| 对应聚合 | {聚合A} |
| 对应领域服务 | {领域服务X} |

**方法列表**

| 方法名 | 职责 | 调用的领域方法 |
|-------|------|--------------|
| {方法1} | {职责描述} | {聚合根}.{方法X}() |

---

#### 5.2 方法：{方法名1}(cmd)

**方法签名**

```typescript
async {方法名}(cmd: {Command类型}): Promise<{Result类型}>
```

**业务含义**

{方法的业务含义描述}

**前置条件**

- {前置条件1}
- {前置条件2}

**后置条件**

- {后置条件1}
- {后置条件2}

**约束定义**

| 约束ID | 类型 | 描述 | 伪代码 | 执行时机 |
|-------|------|------|-------|---------|
| APP-{服务缩写}-01 | 参数校验 | {约束描述} | `ASSERT {条件表达式}` | 执行时 |
| APP-{服务缩写}-02 | 权限校验 | {约束描述} | `ASSERT {条件表达式}` | 执行时 |

**用例设计**

**Case-APP-N1: {正向场景}**

| Given | When | Then | 验证约束 |
|-------|------|------|---------|
| {前置状态} | {方法名}({参数}={值}) | {结果描述} | APP-{服务缩写}-01 ✓ |

**Case-APP-B1: {约束违反场景}**

| Given | When | Then | 违反约束 |
|-------|------|------|---------|
| {前置状态} | {方法名}({参数}={非法值}) | 拒绝，"{错误信息}" | APP-{服务缩写}-01 ✗ |

**Case-APP-E1: 边界场景**

| Given | When | Then | 验证约束 |
|-------|------|------|---------|
| {边界条件} | {方法名}({参数}={边界值}) | {结果描述} | APP-{服务缩写}-01 ✓ |


（内容结构同上）